---
layout : article
title: 
aside:
  toc: true
tags: ComputerArchitecture
category : Programming
author: melonicedlatte
published : True
key : 2019-06-16-232900
---

## AHCI 소개
- AHCI는 인텔에서 SATA장치(하드디스크)와 호스트(AHCI HBA[Host Bus Adapter] == AHCI Controller) 사이에 **데이터 이동을 위한 일종의 프로토콜**이다. 하드웨어 구조이기도 하다. 
- AHCI 컨트롤러를 사용하면 메모리맵핑 방식의 코드를 사용해서 손쉽게 SATA 장치의 레지스터에 접근 가능하다
- AHCI 컨트롤러의 경우 내부적으로 최대 32개의 포트를 가지고 있어서 최대 32개의 다른 SATA 장치를 다룰 수 있다. 

## SATA 소개
- SATA 장치는 AHCI 컨트롤러(호스트) 사이에서 데이터를 교환할 때, FIS(Frame Information Structure) 를 사용한다. 
- FIS는 8가지 종류로 구성된 구조체다. 각각의 명령에 따라서 알맞은 FIS를 사용한다. 
- 기존의 인터페이스(=연결방식)이 하드디스크의 느린 속도를 커버할 수 없었음. 따라서 등장.
- 40개 정도의 많은 핀을 사용한 불편한 PATA에서 핀 개수가 줄어든 SATA로 옮겨오게 됨
- AHCI(Advanced Host Controller Interface) 규격이 지원 되는 경우에는 전원이 켜진 상태에서도 하드 디스크의 교체가 가능한 핫 스와핑 기능 지원 가능

- AHCI HBA 내부 레지스터 접근하기
  - Generic Host Control Registers : 컨트롤러 전체를 제어하는 역할
  - Port Control Register : 각각 연결된 SATA 장치를 제어하는 역할


- NVMe 와 AHCI의 개념은?
  - SSD나 HDD 같은 데이터 저장 장치에서 파일을 주고 받기 위한 일종의 규약 == 프로토콜이다
  - SATA와 PCIe가 자동차가 움직이는 도로라고 한다면, AHCI와 NVMe는 도로위에 설치된 신호등
  - NVMe(Non-Volatile Memory Host Controller Interface Specification) 은 비휘발성 메모리 호스트 컨트롤러 인터페이스 사양 의 줄임말이다.
  - SSD를 지원하기 위해 등장했다고 생각하면 된다.
  - NVMe는 SSD에서 볼 수 있는 여러 수준의 병렬화를 허용.
  - NvMe는 입출력 부하를 줄이고 길이가 긴 다중 명령 큐, 감소된 레이턴시 등 여러 가지가 개선됨

- 왜 새로운 신호등인 NVMe가 필요하게 되었을까?
  - AHCI는 디스크가 회전하면서 데이터를 읽는 HDD를 최적으로 사용하기 위한 기술이다.
  - 하지만, AHCI는 하나의 커맨드를 완료하는 과정에서 9번이나 레지스터를 접근해야 하고 그로 인한 delay가 발생할 수 밖에 없다. 이는 SSD의 속도를 완벽하게 소화할 수 없다는 뜻이다.
  - NVMe는 SSD를 최대한 활용하기 위해서 물리적인 대역폭 한계 극복과 delay에 따른 오버헤드를 없애려고 하였다.
  - SATA는 물리적 대역폭이 부족하여 PCIe를 버스 인터페이스로 사용하였고, 그 결과 외부 컨트롤러를 거쳐 내부 버스를 통해 cpu와 메모리로 전달되는 구조에 따른 delay를 해결하면서 물리적인 대역폭 한계도 극복했다. 
  - AHCI의 가장큰 문제인 커맨드 처리에 따른 지연과 오버헤드는 레지스터 접근을 2번으로 줄이는 구조로 해결했다.
  - NVMe는 하나의 큐마다 64K 개의 엔트리를 보유할 수 있고, 최대 64K 개의 큐를 생성할 수 있다. 하나의 커맨드 리스트로 32개의 커맨드만 소화할 수 있는 AHCI 보다 훨씬 많은 대량의 커맨드를 처리 가능하다.
  - NVMe는 또 멀티코어에도 대응이 가능하다.

- NVMe의 특징
  - NVMe를 통해서 호스트의 디바이스 드라이버는 다양한 SSD를 NVMe라는 통일된 인터페이스로 다룰 수 있다.
  - 그림에서 볼 수 있는 것처럼 AHCI HBA 같은 중간에 끼어 있는 장치 없이 바로 상대 디바이스의 레지스터에 접근할 수 있다.
  - PCIe 버스기반이라 데이터 입출력 속도도 빠르다. 

- NVMe 컨트롤러가 호스트와 어떻게 서로 작동하는가?
  - link : https://m.blog.naver.com/eldkrpdla121/220536014853
  - NVMe 컨트롤러에게 명령을 내리기 위해서는 메모리에 아래와 같은 3종류의 큐를 직접 코딩해서 만들어야 한다. 그리고 주소값을 NVMe Controller에게 알려주면 된다. 
    § Admin 용 큐 
    § I/O Submission Queue(명령어 큐)
    § I/O Completion Queue(결과값 큐)
  - 큐들은 코어별로 설치가 가능하기 때문에, 멀티프로세서일 경우 효율이 좋아진다.
  - 위의 설치된 큐를 통해 NVMe 컨트롤러로 I/O 명령어를 내리는 상황을 살펴보자.
    i. 적당한 코어를 선택하고 해당 코어의 I/O Submission Queue에 명령어를 넣는다.
    ii. 호스트는 NVMe 컨트롤러의 Submission Queue Tail Doorbell 레지스터를 사용하여 NVMe 컨트롤러에 새로운 명령어의 존재를 알린다. 
    iii. NVMe 컨트롤러가 큐(시스템 메모리)의 명령어를 가져온다.
    iv. NVMe 컨트롤러가 가져온 명령어를 처리한다. ( SSD - 시스템 메모리상의 입출력 작동 )
    v. NVMe 컨트롤러는 명령어 처리가 끝나면 I/O Completion Queue에 처리결과를 넣는다.
    vi. NVMe 컨트롤러는 적당한 MSI_X 인터럽트를 방생시킨다.
    vii. 호스트의 인터럽트 서비스 루틴은 처리결과를 I/O Completion Queue에서 꺼내서 확인한다.
    viii. 호스트는 인터럽트 확인을 마쳤다는 의미로 Completion Queue Head Doorbell 레지스터를 사용한다. 

- AHCI와 NVMe의 특징 요약
  - NVMe는 스토리지 장치를 위한 신호 규약
  - PCIe 버스를 사용하는 SSD에만 적용된다
  - 커맨드 처리 시간이 짧아서 고속 데이터 전송과 대량의 데이터 요구를 동시 처리 가능

	
병렬화 및 다중 스레드	명령 발행을 위해 동기화 락이 필요	락 없음
	명령 매개변수는 2개의 직렬화된 호스트 DRAM 페치 필요	하나의 64바이트 페치의 명령 매개변수를 가져옴


|                      | AHCI                 | NVMe          |
| :------------------- | :------------------- |:---------------|
| 최대 큐 깊이  | 하나의 명령 큐 <br> 큐 하나 당 | $2^{16}$개의 큐 <br> 큐 하나당 $2^{16}$개의 명령 |
| 캐시 불가능한 레지스터 접근 수 | 	큐에 없는 명령마다 6개 <br> 큐에 있는 명령마다 9개 | 명령 당 2개            |
| 병렬화 및 다중 스레드  | 	명령 발행을 위해 동기화 락이 필요 | 락 없음  |
| 4KB 명령의 효율성  | 명령 매개변수는 2개의 직렬화된 호스트 DRAM 페치 필요 | 하나의 64바이트 페치의 명령 매개변수를 가져옴 |